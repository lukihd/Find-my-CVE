#!/bin/bash
while [ -n "$1" ]; do
    case "$1" in
    --id) id="$2"; shift ;;
    --prod) prod="$2"; shift ;;
    --pages) pages="$2"; shift ;;
    --help) echo -e "Usage : ./test.sh --id </xxx/yyy> --prod <product-name> --pages <total-of-pages>
    \nxxx -> vendor_id\nyyy -> product_id\npages -> go on 'All Versions' page of the product to look at
    \nExample : ./test.sh --id /45/66/ --prod /Apache-Http-Server --pages 6
    \nhttps://cvedetails.com/
    \nMore info at : https://github.com/lukihd/Find-my-CVE"; exit 1;;
    *) echo "Option $1 not recognized"; exit 1 ;;
    esac
    shift
done

c=1

while [ $c -le $pages ]
do
  curl -s "https://www.cvedetails.com/version-list/${id}${c}${prod}.html" |
    grep -oP '(vulnerability-list/vendor).*(title="Vulnerabilities)' |
    grep -oP '(vulnerability).*(html)' >> urls
    c=$((c+1));
done

echo "Links saved in urls"

while read p; do
  f=`echo "$p" | awk -F"/" '{print $5}'| sed 's/^[^-]*-//g' | sed 's/\(.*\)-/\1:/' | awk -F":" '{print $1}'`
  v=`echo "$p" | awk -F"/" '{print $5}' | sed 's/\.html.*//' | sed 's/^[^-]*-//g' | sed 's/\(.*\)-/\1:/'`
  echo "<$v>" >> "$f"
  curl -s https://www.cvedetails.com/"$p" |
    pup 'div[id="searchresults"] json{}' |
    grep "text" |
    sed '/"text": "1"/,$!d' |
    sed "s/^[ \t]*//" >> "$f"
done <urls

echo "CVE list saved in $f"


: << --long_comment--
  Next step, replace all text field by their respective name (cve_id, cwe_id, ..)

  sed '0,/text/{s/text/number/}' |
  sed '0,/text/{s/text/cve_id/}' |
  sed '0,/text/{s/text/cwe_id/}' |
  sed '0,/text/{s/text/vulnerability_type/}' |
  sed '0,/text/{s/text/publish_date/}' |
  sed '0,/text/{s/text/update_date/}' |
  sed '0,/text/{s/text/score/}' |
  sed '0,/text/{s/text/gained_access_level/}' |
  sed '0,/text/{s/text/access/}' |
  sed '0,/text/{s/text/access_complexity/}' |
  sed '0,/text/{s/text/authentification/}' |
  sed '0,/text/{s/text/confidentiality_impact/}' |
  sed '0,/text/{s/text/integrity_impact/}' |
  sed '0,/text/{s/text/availibity_impact/}' |
  sed '0,/text/{s/text/description/}'
--long_comment--
