#!/bin/bash
while [ -n "$1" ]; do
    case "$1" in
    --id) id="$2"; shift ;;
    --prod) prod="$2"; shift ;;
    --pages) pages="$2"; shift ;;
    --help) echo -e "Usage : ./test.sh --id </xxx/yyy> --prod </product-name> --pages <total-of-pages>
    \nxxx -> vendor_id\nyyy -> product_id\npages -> go on 'All Versions' page of the product to look at
    \nExample : ./cve-dl.sh --id /45/66/ --prod /Apache-Http-Server --pages 6
    \nhttps://cvedetails.com/
    \nMore info at : https://github.com/lukihd/Find-my-CVE"; exit 1;;
    *) echo "Option $1 not recognized"; exit 1 ;;
    esac
    shift
done

c=1
urls=`echo $prod | sed 's/\///'`
urlfile=`echo $urls"urls"`

touch "$urlfile"

while [ $c -le $pages ]
do
  curl -s "https://www.cvedetails.com/version-list/${id}${c}${prod}.html" |
    grep -oP '(vulnerability-list/vendor).*(title="Vulnerabilities)' |
    grep -oP '(vulnerability).*(html)' >> "$urlfile"
    c=$((c+1));
done

echo "Links saved in urls"

while read p; do
  f=`echo "$p" | awk -F"/" '{print $5}'| sed 's/^[^-]*-//g' | sed 's/\(.*\)-/\1:/' | awk -F":" '{print $1}'`
  v=`echo "$p" | awk -F"/" '{print $5}' | sed 's/\.html.*//' | sed 's/^[^-]*-//g' | sed 's/\(.*\)-/\1:/'`
  echo "<$v>" >> "$f"
  curl -s https://www.cvedetails.com/"$p" |
    pup 'div[id="searchresults"] json{}' |
    grep "text" |
    sed '/"text": "1"/,$!d' |
    sed "s/^[ \t]*//" >> "$f"
done <$urlfile

echo "CVE list saved in $f"


: << --long_comment--
  number
  cve_id
  cwe_id
  vulnerability_type
  publish_date
  update_date
  score
  gained_access_level
  access
  access_complexity
  authentification
  confidentiality_impact
  integrity_impact
  availibity_impact
  description
--long_comment--
